<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Code Editor</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .header {
      background: #2a2a2a;
      padding: 12px 16px;
      border-bottom: 1px solid #3a3a3a;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .title { font-weight: bold; color: #4ade80; font-size: 16px; }
    .toolbar {
      display: flex;
      gap: 8px;
    }
    .toolbar button {
      background: #3a3a3a;
      border: none;
      color: #e0e0e0;
      padding: 6px 14px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
    }
    .toolbar button:hover { background: #4a4a4a; }
    .toolbar button.primary {
      background: #4ade80;
      color: #1a1a1a;
    }
    .toolbar button.primary:hover { background: #22c55e; }
    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .file-tree {
      width: 280px;
      background: #242424;
      border-right: 1px solid #3a3a3a;
      overflow-y: auto;
      padding: 12px;
    }
    .tree-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      margin-bottom: 12px;
    }
    .tree-header h3 {
      color: #4ade80;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .tree-actions button {
      background: transparent;
      border: none;
      color: #999;
      cursor: pointer;
      padding: 4px 8px;
      font-size: 14px;
    }
    .tree-actions button:hover { color: #4ade80; }
    .folder, .file {
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 2px 0;
    }
    .folder:hover, .file:hover { background: #2a2a2a; }
    .file.active { background: #3a3a3a; color: #4ade80; }
    .folder-icon, .file-icon {
      font-size: 14px;
      width: 16px;
    }
    .folder-content {
      padding-left: 20px;
    }
    .folder.collapsed .folder-content { display: none; }
    .editor-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #1e1e1e;
    }
    .tabs-container {
      display: flex;
      background: #252525;
      border-bottom: 1px solid #3a3a3a;
      overflow-x: auto;
    }
    .tab {
      padding: 10px 16px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    .tab:hover { background: #2a2a2a; }
    .tab.active {
      border-bottom-color: #4ade80;
      background: #1e1e1e;
    }
    .tab-close {
      margin-left: 8px;
      opacity: 0.6;
      font-size: 14px;
    }
    .tab-close:hover { opacity: 1; color: #ff5f56; }
    .editor-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    .code-editor-container {
      position: relative;
      width: 100%;
      height: 100%;
      min-height: 500px;
      border: 1px solid #3a3a3a;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
    }
    .code-editor-container:focus-within {
      border-color: #4ade80;
    }
    .line-numbers {
      background: #252525;
      color: #666;
      padding: 16px 8px;
      font-family: 'Courier New', Consolas, 'Lucida Console', monospace;
      font-size: 14px;
      line-height: 1.6;
      text-align: right;
      user-select: none;
      border-right: 1px solid #3a3a3a;
      overflow: hidden;
      min-width: 50px;
    }
    .editor-wrapper {
      position: relative;
      flex: 1;
      overflow: hidden;
    }
    .code-textarea {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      border: none;
      color: transparent;
      caret-color: #4ade80;
      padding: 16px;
      font-family: 'Courier New', Consolas, 'Lucida Console', monospace;
      font-size: 14px;
      line-height: 1.6;
      resize: none;
      tab-size: 2;
      z-index: 2;
      overflow: auto;
    }
    .code-textarea:focus {
      outline: none;
    }
    .code-highlight {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      padding: 16px;
      font-family: 'Courier New', Consolas, 'Lucida Console', monospace;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      z-index: 1;
      overflow: auto;
      pointer-events: none;
      background: #1e1e1e;
    }
    .keyword { color: #c586c0; }
    .string { color: #ce9178; }
    .comment { color: #6a9955; font-style: italic; }
    .number { color: #b5cea8; }
    .function { color: #dcdcaa; }
    .operator { color: #d4d4d4; }
    .property { color: #9cdcfe; }
    .constant { color: #4fc1ff; }
    .tag { color: #569cd6; }
    .punctuation { color: #d4d4d4; }
    .status-bar {
      background: #2a2a2a;
      border-top: 1px solid #3a3a3a;
      padding: 6px 16px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .status-item {
      display: flex;
      gap: 16px;
    }
    .status-item span {
      color: #999;
    }
    .search-bar {
      background: #2a2a2a;
      padding: 12px 16px;
      border-bottom: 1px solid #3a3a3a;
      display: none;
      flex-direction: column;
      gap: 8px;
    }
    .search-bar.active {
      display: flex;
    }
    .search-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .search-bar input {
      flex: 1;
      background: #1e1e1e;
      border: 1px solid #3a3a3a;
      color: #e0e0e0;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
    }
    .search-bar input:focus {
      outline: none;
      border-color: #4ade80;
    }
    .search-bar button {
      background: #3a3a3a;
      border: none;
      color: #e0e0e0;
      padding: 8px 14px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
    }
    .search-bar button:hover {
      background: #4a4a4a;
    }
    .search-bar button.primary {
      background: #4ade80;
      color: #1a1a1a;
    }
    .search-bar button.primary:hover {
      background: #22c55e;
    }
    .search-info {
      font-size: 11px;
      color: #999;
      padding: 0 4px;
    }
    .modified-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ffbd2e;
      display: inline-block;
    }
    .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
    .toast { padding: 12px 16px; margin-bottom: 8px; border-radius: 4px; font-size: 13px; max-width: 300px; word-wrap: break-word; animation: slideIn 0.3s ease-out; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    @keyframes slideIn { from { transform: translateX(350px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { to { transform: translateX(350px); opacity: 0; } }
    .toast.success { background: #4caf50; color: white; }
    .toast.error { background: #f48771; color: white; }
    .toast.warning { background: #ff9800; color: white; }
    .toast.info { background: #2196F3; color: white; }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>
  <div class="header">
    <div class="title">üíª Code Editor</div>
    <div class="toolbar">
      <button onclick="newFile()">New File</button>
      <button onclick="saveFile()" class="primary">Save</button>
      <button onclick="saveAll()">Save All</button>
      <button onclick="toggleSearch()">Find</button>
    </div>
  </div>
  <div class="search-bar" id="searchBar">
    <div class="search-row">
      <input type="text" placeholder="Find..." id="findInput" />
      <button onclick="findNext()">Next</button>
      <button onclick="findPrevious()">Previous</button>
      <span class="search-info" id="findInfo"></span>
      <button onclick="toggleReplace()" id="replaceToggle">Replace</button>
      <button onclick="toggleSearch()">‚úï</button>
    </div>
    <div class="search-row" id="replaceRow" style="display: none;">
      <input type="text" placeholder="Replace with..." id="replaceInput" />
      <button onclick="replaceNext()" class="primary">Replace</button>
      <button onclick="replaceAll()" class="primary">Replace All</button>
    </div>
  </div>
  <div class="main">
    <div class="file-tree">
      <div class="tree-header">
        <h3>Files</h3>
        <div class="tree-actions">
          <button onclick="newFile()" title="New File">üìÑ</button>
          <button onclick="newFolder()" title="New Folder">üìÅ</button>
          <button onclick="refreshTree()" title="Refresh">‚Üª</button>
        </div>
      </div>
      <div id="treeContent">
        <div class="folder" onclick="toggleFolder(this)">
          <span class="folder-icon">üìÅ</span>
          <span>tasks</span>
          <div class="folder-content">
            <div class="file" onclick="openFile(event, 'tasks/example-simple.js')">
              <span class="file-icon">üìÑ</span>
              <span>example-simple.js</span>
            </div>
            <div class="file" onclick="openFile(event, 'tasks/example-flow.js')">
              <span class="file-icon">üìÑ</span>
              <span>example-flow.js</span>
            </div>
            <div class="file" onclick="openFile(event, 'tasks/config.json')">
              <span class="file-icon">üìã</span>
              <span>config.json</span>
            </div>
          </div>
        </div>
        <div class="folder" onclick="toggleFolder(this)">
          <span class="folder-icon">üìÅ</span>
          <span>lib</span>
          <div class="folder-content">
            <div class="file" onclick="openFile(event, 'lib/utils.js')">
              <span class="file-icon">üìÑ</span>
              <span>utils.js</span>
            </div>
            <div class="file" onclick="openFile(event, 'lib/api.js')">
              <span class="file-icon">üìÑ</span>
              <span>api.js</span>
            </div>
          </div>
        </div>
        <div class="file" onclick="openFile(event, 'package.json')">
          <span class="file-icon">üìã</span>
          <span>package.json</span>
        </div>
        <div class="file" onclick="openFile(event, 'README.md')">
          <span class="file-icon">üìù</span>
          <span>README.md</span>
        </div>
      </div>
    </div>
    <div class="editor-area">
      <div class="tabs-container" id="tabsContainer">
        <div class="tab active" onclick="switchToTab('welcome')">
          Welcome
          <span class="tab-close" onclick="closeTab(event, 'welcome')">√ó</span>
        </div>
      </div>
      <div class="editor-content" id="editorContent">
        <div style="text-align: center; padding: 60px 40px; color: #666;">
          <h2 style="color: #4ade80; margin-bottom: 20px; font-size: 28px;">Welcome to Code Editor</h2>
          <p style="font-size: 16px; margin-bottom: 30px;">Your comprehensive development environment for Sequential ecosystem</p>
          <div style="background: #242424; border-radius: 12px; padding: 30px; max-width: 600px; margin: 0 auto;">
            <h3 style="color: #e0e0e0; margin-bottom: 16px;">Quick Start</h3>
            <ul style="text-align: left; list-style: none; padding: 0;">
              <li style="padding: 8px 0; border-bottom: 1px solid #3a3a3a;">üìÑ Click a file in the tree to open it</li>
              <li style="padding: 8px 0; border-bottom: 1px solid #3a3a3a;">üíæ Ctrl+S to save current file</li>
              <li style="padding: 8px 0; border-bottom: 1px solid #3a3a3a;">üîç Use Find to search across files</li>
              <li style="padding: 8px 0;">üìÅ Right-click tree for more options</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="status-bar">
        <div class="status-item">
          <span id="currentFile">Welcome</span>
          <span id="lineCol">Line 1, Col 1</span>
          <span id="fileType">Markdown</span>
        </div>
        <div class="status-item">
          <span id="encoding">UTF-8</span>
          <span id="modified" style="display: none;">
            <span class="modified-indicator"></span> Modified
          </span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // [Storage-Manager-Injected]

function createStorageManager(appId) {
  const stateKey = `app-state:${appId}`;
  const expiryKey = `app-state-expiry:${appId}`;
  return {
    save(state, ttlMs = null) {
      try {
        localStorage.setItem(stateKey, JSON.stringify(state));
        if (ttlMs) {
          const expiryTime = Date.now() + ttlMs;
          localStorage.setItem(expiryKey, expiryTime.toString());
        }
      } catch (error) {
        console.error(`[Storage] Failed to save state for ${appId}:`, error);
      }
    },
    load() {
      try {
        const expiryTime = localStorage.getItem(expiryKey);
        if (expiryTime && Date.now() > parseInt(expiryTime)) {
          this.clear();
          return null;
        }
        const stateStr = localStorage.getItem(stateKey);
        return stateStr ? JSON.parse(stateStr) : null;
      } catch (error) {
        console.error(`[Storage] Failed to load state for ${appId}:`, error);
        return null;
      }
    },
    clear() {
      try {
        localStorage.removeItem(stateKey);
        localStorage.removeItem(expiryKey);
      } catch (error) {
        console.error(`[Storage] Failed to clear state for ${appId}:`, error);
      }
    }
  };
}

    const storage = createStorageManager('app-code-editor');
    const savedState = storage.load();
    if (savedState) {
      openFiles = { ...openFiles, ...savedState.openFiles };
      currentFile = savedState.currentFile || currentFile;
    }
    window.addEventListener('beforeunload', () => {
      storage.save({ openFiles, currentFile });
    });
  

    function showToast(message, type = "info", duration = 3000) { const c = document.getElementById("toastContainer"); if (!c) return; const t = document.createElement("div"); t.className = `toast ${type}`; t.textContent = message; c.appendChild(t); setTimeout(() => { t.style.animation = "slideOut 0.3s ease-out forwards"; setTimeout(() => t.remove(), 300); }, duration); } function showError(message) { showToast(message, "error"); } function showSuccess(message) { showToast(message, "success"); } function showWarning(message) { showToast(message, "warning"); }
    let openFiles = {
      'welcome': { name: 'Welcome', content: '', type: 'md', modified: false }
    };
    let currentFile = 'welcome';

    const fileContents = {
      'tasks/example-simple.js': `export async function myTask(input) {
  const response = await fetch('https://api.example.com/data');
  const data = await response.json();
  return { success: true, data };
}`,
      'tasks/example-flow.js': `export const graph = {
  id: 'example-flow',
  initial: 'fetchData',
  states: {
    fetchData: { onDone: 'process', onError: 'handleError' },
    process: { onDone: 'complete' },
    handleError: { type: 'final' },
    complete: { type: 'final' }
  }
};

export async function fetchData(input) {
  return await __callHostTool__('api', 'getData', { id: input.userId });
}`,
      'tasks/config.json': `{
  "name": "my-task",
  "runner": "sequential-js",
  "inputs": [
    { "name": "userId", "type": "string" }
  ]
}`,
      'lib/utils.js': `export function formatDate(date) {
  return new Date(date).toISOString();
}

export function validateInput(input) {
  return input && typeof input === 'object';
}`,
      'package.json': `{
  "name": "sequential-project",
  "version": "1.0.0",
  "type": "module",
  "dependencies": {
    "sequential-fetch": "latest"
  }
}`,
      'README.md': `# Sequential Project

This is a Sequential ecosystem project.

## Features

- Auto-pause on HTTP calls
- State-based workflow execution
- Content-addressable filesystem

## Usage

\`\`\`bash
npx sequential-ecosystem run my-task --input '{"userId":"123"}'
\`\`\``
    };

    function openFile(event, path) {
      event.stopPropagation();

      document.querySelectorAll('.file').forEach(f => f.classList.remove('active'));
      event.currentTarget.classList.add('active');

      if (!openFiles[path]) {
        const fileName = path.split('/').pop();
        const fileType = fileName.split('.').pop();
        openFiles[path] = {
          name: fileName,
          content: fileContents[path] || `// ${fileName}\n\n// Edit your code here`,
          type: fileType,
          modified: false,
          path: path
        };
      }

      currentFile = path;
      renderTabs();
      renderEditor();
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function renderTabs() {
      const container = document.getElementById('tabsContainer');
      container.innerHTML = Object.entries(openFiles).map(([path, file]) => `
        <div class="tab ${path === currentFile ? 'active' : ''}" onclick="switchToTab('${escapeHtml(path)}')">
          ${file.modified ? '<span class="modified-indicator"></span>' : ''}
          ${escapeHtml(file.name)}
          <span class="tab-close" onclick="closeTab(event, '${escapeHtml(path)}')">√ó</span>
        </div>
      `).join('');
    }

    function renderEditor() {
      const file = openFiles[currentFile];
      const content = document.getElementById('editorContent');

      if (currentFile === 'welcome') {
        content.innerHTML = `
          <div style="text-align: center; padding: 60px 40px; color: #666;">
            <h2 style="color: #4ade80; margin-bottom: 20px;">Welcome to Code Editor</h2>
            <p style="margin-bottom: 30px;">Select a file from the tree to start editing</p>
          </div>
        `;
      } else {
        content.innerHTML = `
          <div class="code-editor-container">
            <div class="line-numbers" id="lineNumbers"></div>
            <div class="editor-wrapper">
              <div class="code-highlight" id="codeHighlight"></div>
              <textarea class="code-textarea" id="codeArea" spellcheck="false">${escapeHtml(file.content)}</textarea>
            </div>
          </div>
        `;
        const textarea = document.getElementById('codeArea');
        const highlight = document.getElementById('codeHighlight');
        const lineNumbers = document.getElementById('lineNumbers');

        const updateLineNumbers = () => {
          const lines = textarea.value.split('\n');
          lineNumbers.innerHTML = lines.map((_, i) => `${i + 1}\n`).join('');
        };

        const updateHighlight = () => {
          highlight.innerHTML = syntaxHighlight(textarea.value, file.type);
          updateLineNumbers();
          syncScroll();
        };

        const syncScroll = () => {
          highlight.scrollTop = textarea.scrollTop;
          highlight.scrollLeft = textarea.scrollLeft;
          lineNumbers.scrollTop = textarea.scrollTop;
        };

        textarea.addEventListener('input', () => {
          file.content = textarea.value;
          file.modified = true;
          updateHighlight();
          renderTabs();
          updateStatus();
        });
        textarea.addEventListener('scroll', syncScroll);
        textarea.addEventListener('keydown', handleKeydown);
        updateHighlight();
        updateStatus();
      }
    }

    function handleKeydown(e) {
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        saveFile();
      } else if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        toggleSearch();
        document.getElementById('findInput').focus();
      } else if (e.ctrlKey && e.key === 'h') {
        e.preventDefault();
        toggleSearch();
        toggleReplace();
        document.getElementById('findInput').focus();
      } else if (e.key === 'Tab') {
        e.preventDefault();
        const start = e.target.selectionStart;
        const end = e.target.selectionEnd;
        e.target.value = e.target.value.substring(0, start) + '  ' + e.target.value.substring(end);
        e.target.selectionStart = e.target.selectionEnd = start + 2;
      }
    }

    function updateStatus() {
      const file = openFiles[currentFile];
      document.getElementById('currentFile').textContent = file.path || file.name;
      document.getElementById('fileType').textContent = file.type.toUpperCase();
      document.getElementById('modified').style.display = file.modified ? 'block' : 'none';
    }

    function switchToTab(path) {
      currentFile = path;
      renderTabs();
      renderEditor();
    }

    function closeTab(event, path) {
      event.stopPropagation();
      if (openFiles[path].modified) {
        if (!confirm(`Save changes to ${openFiles[path].name}?`)) {
          return;
        }
      }
      delete openFiles[path];
      if (currentFile === path) {
        currentFile = Object.keys(openFiles)[0] || 'welcome';
      }
      renderTabs();
      renderEditor();
    }

    async function saveFile() {
      if (currentFile === 'welcome') return;
      const file = openFiles[currentFile];
      try {
        const res = await fetch('/api/files/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: file.path, content: file.content })
        });
        const result = await res.json();
        if (result.success) {
          file.modified = false;
          renderTabs();
          updateStatus();
          console.log('Saved:', file.path);
          const statusEl = document.getElementById('currentFile');
          const originalText = statusEl.textContent;
          statusEl.textContent = `‚úì Saved ${file.name}`;
          statusEl.style.color = '#4ade80';
          setTimeout(() => {
            statusEl.textContent = originalText;
            statusEl.style.color = '';
          }, 2000);
        } else {
          showError(`Save failed: ${result.error}`);
        }
      } catch (error) {
        showError(`Save error: ${error.message}`);
      }
    }

    async function saveAll() {
      const filesToSave = Object.values(openFiles).filter(f => f.modified && f.path);
      let successCount = 0;
      for (const file of filesToSave) {
        try {
          const res = await fetch('/api/files/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: file.path, content: file.content })
          });
          const result = await res.json();
          if (result.success) {
            file.modified = false;
            successCount++;
          }
        } catch (error) {
          console.error('Failed to save', file.path, error);
        }
      }
      renderTabs();
      updateStatus();
      showError(`Saved ${successCount} of ${filesToSave.length} files!`);
    }

    function newFile() {
      const name = prompt('File name:');
      if (name) {
        openFiles[name] = {
          name: name,
          content: '',
          type: name.split('.').pop() || 'txt',
          modified: true,
          path: name
        };
        currentFile = name;
        renderTabs();
        renderEditor();
      }
    }

    function toggleFolder(el) {
      el.classList.toggle('collapsed');
    }

    let currentSearchIndex = 0;
    let searchMatches = [];

    function toggleSearch() {
      const bar = document.getElementById('searchBar');
      bar.classList.toggle('active');
      if (bar.classList.contains('active')) {
        document.getElementById('findInput').focus();
      } else {
        document.getElementById('replaceRow').style.display = 'none';
      }
    }

    function toggleReplace() {
      const row = document.getElementById('replaceRow');
      row.style.display = row.style.display === 'none' ? 'flex' : 'none';
    }

    function findMatches() {
      if (currentFile === 'welcome') return [];
      const file = openFiles[currentFile];
      const findText = document.getElementById('findInput').value;
      if (!findText) return [];
      const content = file.content;
      const matches = [];
      let index = 0;
      while ((index = content.indexOf(findText, index)) !== -1) {
        matches.push(index);
        index += findText.length;
      }
      return matches;
    }

    function updateSearchInfo() {
      searchMatches = findMatches();
      const info = document.getElementById('findInfo');
      if (searchMatches.length === 0) {
        info.textContent = 'No matches';
        currentSearchIndex = 0;
      } else {
        info.textContent = `${currentSearchIndex + 1} of ${searchMatches.length}`;
      }
    }

    function selectMatch(index) {
      if (searchMatches.length === 0) return;
      const textarea = document.getElementById('codeArea');
      if (!textarea) return;
      const findText = document.getElementById('findInput').value;
      const start = searchMatches[index];
      textarea.focus();
      textarea.setSelectionRange(start, start + findText.length);
      textarea.scrollTop = Math.max(0, (start / textarea.value.length) * textarea.scrollHeight - 200);
    }

    function findNext() {
      updateSearchInfo();
      if (searchMatches.length === 0) return;
      currentSearchIndex = (currentSearchIndex + 1) % searchMatches.length;
      selectMatch(currentSearchIndex);
      updateSearchInfo();
    }

    function findPrevious() {
      updateSearchInfo();
      if (searchMatches.length === 0) return;
      currentSearchIndex = (currentSearchIndex - 1 + searchMatches.length) % searchMatches.length;
      selectMatch(currentSearchIndex);
      updateSearchInfo();
    }

    function replaceNext() {
      if (currentFile === 'welcome') return;
      const file = openFiles[currentFile];
      const findText = document.getElementById('findInput').value;
      const replaceText = document.getElementById('replaceInput').value;
      if (!findText) return;
      const index = file.content.indexOf(findText);
      if (index !== -1) {
        file.content = file.content.substring(0, index) + replaceText + file.content.substring(index + findText.length);
        file.modified = true;
        renderEditor();
        updateSearchInfo();
      }
    }

    function replaceAll() {
      if (currentFile === 'welcome') return;
      const file = openFiles[currentFile];
      const findText = document.getElementById('findInput').value;
      const replaceText = document.getElementById('replaceInput').value;
      if (!findText) return;
      const count = (file.content.match(new RegExp(findText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g')) || []).length;
      if (count === 0) {
        showError('No matches found');
        return;
      }
      if (confirm(`Replace ${count} occurrences?`)) {
        file.content = file.content.split(findText).join(replaceText);
        file.modified = true;
        renderEditor();
        updateSearchInfo();
      }
    }

    document.getElementById('findInput').addEventListener('input', updateSearchInfo);

    function newFolder() {
      showError('New folder functionality would create a folder in the file tree');
    }

    function refreshTree() {
      showError('Refresh would reload the file tree from the server');
    }

    function syntaxHighlight(code, fileType) {
      const escape = (str) => str.replace(/</g, '&lt;').replace(/>/g, '&gt;');

      if (fileType === 'js' || fileType === 'jsx' || fileType === 'ts' || fileType === 'tsx') {
        return highlightJavaScript(code);
      } else if (fileType === 'json') {
        return highlightJSON(code);
      } else if (fileType === 'md' || fileType === 'markdown') {
        return highlightMarkdown(code);
      } else {
        return escape(code);
      }
    }

    function highlightJavaScript(code) {
      const keywords = /\b(const|let|var|function|async|await|return|if|else|for|while|do|switch|case|break|continue|import|export|from|default|class|extends|new|this|super|try|catch|finally|throw|typeof|instanceof|void|delete|in|of|yield|static|get|set|constructor|null|undefined|true|false)\b/g;
      const strings = /(["'`])(?:(?=(\\?))\2.)*?\1/g;
      const comments = /(\/\/.*$|\/\*[\s\S]*?\*\/)/gm;
      const numbers = /\b(\d+\.?\d*)\b/g;
      const functions = /\b([a-zA-Z_$][\w$]*)\s*(?=\()/g;
      const operators = /([+\-*/%=<>!&|^~?:])/g;

      return code
        .replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(comments, '<span class="comment">$1</span>')
        .replace(strings, '<span class="string">$1</span>')
        .replace(keywords, '<span class="keyword">$1</span>')
        .replace(numbers, '<span class="number">$1</span>')
        .replace(functions, '<span class="function">$1</span>');
    }

    function highlightJSON(code) {
      const strings = /(["'])(?:(?=(\\?))\2.)*?\1/g;
      const numbers = /\b(-?\d+\.?\d*([eE][+-]?\d+)?)\b/g;
      const booleans = /\b(true|false|null)\b/g;
      const properties = /("(?:[^"\\]|\\.)*")(\s*:)/g;

      return code
        .replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(properties, '<span class="property">$1</span>$2')
        .replace(strings, '<span class="string">$1</span>')
        .replace(numbers, '<span class="number">$1</span>')
        .replace(booleans, '<span class="constant">$1</span>');
    }

    function highlightMarkdown(code) {
      const headings = /^(#{1,6})\s+(.*)$/gm;
      const codeBlocks = /```[\s\S]*?```/g;
      const inlineCode = /`([^`]+)`/g;
      const bold = /\*\*([^*]+)\*\*/g;
      const italic = /\*([^*]+)\*/g;
      const links = /\[([^\]]+)\]\(([^)]+)\)/g;

      return code
        .replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(codeBlocks, '<span class="string">$&</span>')
        .replace(headings, '<span class="keyword">$1</span> <span class="function">$2</span>')
        .replace(inlineCode, '<span class="string">$&</span>')
        .replace(bold, '<span class="keyword">$&</span>')
        .replace(links, '<span class="tag">$&</span>');
    }

    renderTabs();
    renderEditor();
  </script>

  <div id="contextMenuContainer"></div>
  <script>
    class AppContextMenu {
      constructor() {
        this.items = [];
      }
      addItem(label, icon, action, disabled = false) {
        this.items.push({ label, icon, action, disabled });
        return this;
      }
      addDivider() {
        this.items.push({ divider: true });
        return this;
      }
      show(x, y) {
        this.render(x, y);
      }
      render(x, y) {
        const menu = document.createElement('div');
        menu.style.cssText = 'position:fixed;background:#252526;border:1px solid #3c3c3c;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,0.5);z-index:10000;min-width:180px';
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
        this.items.forEach(item => {
          if (item.divider) {
            const div = document.createElement('div');
            div.style.cssText = 'height:1px;background:#3c3c3c';
            menu.appendChild(div);
          } else {
            const el = document.createElement('div');
            el.style.cssText = 'padding:8px 12px;color:#d4d4d4;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:8px';
            el.innerHTML = item.icon + ' ' + item.label;
            if (!item.disabled) {
              el.onmouseover = () => el.style.background = '#3c3c3c';
              el.onmouseout = () => el.style.background = 'transparent';
              el.onclick = () => { item.action(); this.hide(); };
            } else {
              el.style.opacity = '0.5';
              el.style.cursor = 'not-allowed';
            }
            menu.appendChild(el);
          }
        });
        document.getElementById('contextMenuContainer')?.remove();
        menu.id = 'contextMenuContainer';
        document.body.appendChild(menu);
      }
      hide() {
        document.getElementById('contextMenuContainer')?.remove();
      }
    }
    const appContextMenu = new AppContextMenu();
    document.addEventListener('click', () => appContextMenu.hide());
  </script>

  <script src="/error-handler.js"></script>
  <script>
    const errorHandler = new ErrorHandler('app-code-editor');
    window.errorHandler = errorHandler;
  </script>
</body>
</html>
